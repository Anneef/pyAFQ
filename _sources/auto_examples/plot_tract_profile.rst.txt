.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_auto_examples_plot_tract_profile.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_tract_profile.py:


==========================
Plotting tract profiles
==========================

An example of tracking and segmenting two tracts, and plotting their tract
profiles for FA (calculated with DTI). This example uses the Yeatman et al.
waypoint ROI approach, first described in [Yeatman2012]_ and further elaborated
in [Yeatman2014]_.


.. code-block:: default

    import os.path as op
    import matplotlib.pyplot as plt
    import numpy as np
    import nibabel as nib
    import dipy.data as dpd
    from dipy.data import fetcher
    import dipy.tracking.utils as dtu
    import dipy.tracking.streamline as dts
    from dipy.io.streamline import save_tractogram, load_tractogram
    from dipy.stats.analysis import afq_profile, gaussian_weights
    from dipy.io.stateful_tractogram import StatefulTractogram
    from dipy.io.stateful_tractogram import Space

    from AFQ import api
    import AFQ.utils.streamlines as aus
    import AFQ.data as afd
    import AFQ.tractography as aft
    import AFQ.registration as reg
    import AFQ.dti as dti
    import AFQ.segmentation as seg
    from AFQ.utils.volume import patch_up_roi

    import logging
    logging.basicConfig(level=logging.INFO)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    /Users/arokem/.virtualenvs/afq/lib/python3.7/site-packages/dipy/stats/__init__.py:7: UserWarning: The `dipy.stats` module is still under heavy development and functionality, as well as the API is likely to change in future versions of the software
      warnings.warn(w_string)
    /Users/arokem/.virtualenvs/afq/lib/python3.7/site-packages/dask/config.py:168: YAMLLoadWarning: calling yaml.load() without Loader=... is deprecated, as the default Loader is unsafe. Please read https://msg.pyyaml.org/load for full details.
      data = yaml.load(f.read()) or {}



Get example data:
-------------------------


.. code-block:: default


    dpd.fetch_stanford_hardi()
    hardi_dir = op.join(fetcher.dipy_home, "stanford_hardi")
    hardi_fdata = op.join(hardi_dir, "HARDI150.nii.gz")
    hardi_fbval = op.join(hardi_dir, "HARDI150.bval")
    hardi_fbvec = op.join(hardi_dir, "HARDI150.bvec")
    img = nib.load(hardi_fdata)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Dataset is already in place. If you want to fetch it again please first remove the folder /Users/arokem/.dipy/stanford_hardi 



Calculate DTI:
-------------------------


.. code-block:: default


    print("Calculating DTI...")
    if not op.exists('./dti_FA.nii.gz'):
        dti_params = dti.fit_dti(hardi_fdata, hardi_fbval, hardi_fbvec,
                                 out_dir='.')
    else:
        dti_params = {'FA': './dti_FA.nii.gz',
                      'params': './dti_params.nii.gz'}

    FA_img = nib.load(dti_params['FA'])
    FA_data = FA_img.get_fdata()





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Calculating DTI...



Register the individual data to a template:
-------------------------------------------
For the purpose of bundle segmentation, the individual brain is registered
to the MNI T2 template. The waypoint ROIs used in segmentation are then each
brought into each subject's native space to test streamlines for whether they
fulfill the segmentation criteria.

.. note::
    Here, we calculate just a non-linear transformation between the
    individual's brain and the MNI T2 template. In practice, it's a good idea
    to also perform a pre-alignment using an affine transformation. We don't
    do that here, but this is part of the full pipeline implemented in the
    CLI.



.. code-block:: default

    print("Registering to template...")
    MNI_T2_img = dpd.read_mni_template()
    if not op.exists('mapping.nii.gz'):
        import dipy.core.gradients as dpg
        gtab = dpg.gradient_table(hardi_fbval, hardi_fbvec)

        warped_hardi, mapping = reg.syn_register_dwi(hardi_fdata, gtab)
        reg.write_mapping(mapping, './mapping.nii.gz')
    else:
        mapping = reg.read_mapping('./mapping.nii.gz', img, MNI_T2_img)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Registering to template...
    Data size is approximately 70MB
    Dataset is already in place. If you want to fetch it again please first remove the folder /Users/arokem/.dipy/mni_template 



Read in bundle specification
-------------------------------------------
The waypoint ROIs, in addition to bundle probability maps are stored in this
data structure. The templates are first resampled into the MNI space, before
they are brought into the subject's individual native space.
For speed, we only segment two bundles here.


.. code-block:: default


    bundles = api.make_bundle_dict(bundle_names= ["CST", "ARC"],
                                   resample_to=MNI_T2_img)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Dataset is already in place. If you want to fetch it again please first remove the folder /Users/arokem/AFQ_data/templates 
    Dataset is already in place. If you want to fetch it again please first remove the folder /Users/arokem/AFQ_data/callosum_templates 



Tracking
--------
Streamlines are generate using DTI and a deterministic tractography algorithm.
For speed, we seed only within the waypoint ROIs for each bundle.


.. code-block:: default


    print("Tracking...")
    if not op.exists('dti_streamlines.trk'):
        seed_roi = np.zeros(img.shape[:-1])
        for bundle in bundles:
            for idx, roi in enumerate(bundles[bundle]['ROIs']):
                if bundles[bundle]['rules'][idx]:
                    warped_roi = patch_up_roi(
                        mapping.transform_inverse(
                            roi.get_data().astype(np.float32),
                            interpolation='linear'))

                    nib.save(nib.Nifti1Image(warped_roi.astype(float), img.affine),
                             f"{bundle}_{idx+1}.nii.gz")
                    # Add voxels that aren't there yet:
                    seed_roi = np.logical_or(seed_roi, warped_roi)
        nib.save(nib.Nifti1Image(seed_roi.astype(float), img.affine), 'seed_roi.nii.gz')
        sft = aft.track(dti_params['params'], seed_mask=seed_roi,
                        stop_mask=FA_data, stop_threshold=0.1)
        save_tractogram(sft, './dti_streamlines.trk',
                        bbox_valid_check=False)
    else:
        sft = load_tractogram('./dti_streamlines.trk', img)

    sft.to_vox()





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Tracking...



Segmentation
--------
In this stage, streamlines are tested for several criteria: whether the
probability that they belong to a bundle is larger than a threshold (set to 0,
per default), whether they pass through inclusion ROIs and whether they do not
pass through exclusion ROIs.


.. code-block:: default


    print("Segmenting fiber groups...")
    segmentation = seg.Segmentation(return_idx=True)
    segmentation.segment(bundles,
                         sft,
                         fdata=hardi_fdata,
                         fbval=hardi_fbval,
                         fbvec=hardi_fbvec,
                         mapping=mapping,
                         reg_template=MNI_T2_img)

    fiber_groups = segmentation.fiber_groups






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Segmenting fiber groups...
    Dataset is already in place. If you want to fetch it again please first remove the folder /Users/arokem/AFQ_data/aal_atlas 
      0%|          | 0/1893 [00:00<?, ?it/s]     37%|###6      | 698/1893 [00:00<00:00, 6913.77it/s]     61%|######    | 1151/1893 [00:00<00:00, 5953.45it/s]     76%|#######5  | 1432/1893 [00:00<00:00, 3472.76it/s]    100%|##########| 1893/1893 [00:00<00:00, 4497.37it/s]
      0%|          | 0/1532 [00:00<?, ?it/s]     17%|#6        | 259/1532 [00:00<00:00, 2585.66it/s]     25%|##4       | 379/1532 [00:00<00:00, 1917.60it/s]     34%|###3      | 518/1532 [00:00<00:00, 1720.88it/s]    100%|##########| 1532/1532 [00:00<00:00, 3840.58it/s]
      0%|          | 0/2008 [00:00<?, ?it/s]     13%|#3        | 269/2008 [00:00<00:00, 2643.74it/s]     23%|##3       | 469/2008 [00:00<00:00, 2409.54it/s]     29%|##9       | 585/2008 [00:00<00:01, 1163.45it/s]     34%|###3      | 682/2008 [00:00<00:01, 818.48it/s]      38%|###8      | 765/2008 [00:00<00:02, 620.80it/s]     42%|####1     | 835/2008 [00:00<00:02, 573.61it/s]     45%|####4     | 899/2008 [00:01<00:02, 508.52it/s]     48%|####7     | 956/2008 [00:01<00:02, 509.44it/s]     50%|#####     | 1011/2008 [00:01<00:02, 418.59it/s]     53%|#####2    | 1059/2008 [00:01<00:02, 430.31it/s]     55%|#####5    | 1106/2008 [00:01<00:02, 435.05it/s]     57%|#####7    | 1153/2008 [00:01<00:01, 427.70it/s]     61%|######1   | 1225/2008 [00:01<00:01, 485.47it/s]     64%|######4   | 1291/2008 [00:01<00:01, 526.08it/s]     68%|######8   | 1371/2008 [00:02<00:01, 586.03it/s]     73%|#######2  | 1457/2008 [00:02<00:00, 647.51it/s]     76%|#######6  | 1534/2008 [00:02<00:00, 678.80it/s]     80%|########  | 1615/2008 [00:02<00:00, 711.48it/s]     85%|########4 | 1701/2008 [00:02<00:00, 749.64it/s]     89%|########8 | 1779/2008 [00:02<00:00, 756.40it/s]     93%|#########2| 1867/2008 [00:02<00:00, 789.59it/s]     97%|#########7| 1954/2008 [00:02<00:00, 810.44it/s]    100%|##########| 2008/2008 [00:02<00:00, 712.45it/s]
      0%|          | 0/1698 [00:00<?, ?it/s]      7%|6         | 113/1698 [00:00<00:01, 1124.65it/s]     13%|#2        | 215/1698 [00:00<00:01, 1090.34it/s]     19%|#9        | 324/1698 [00:00<00:01, 1087.93it/s]     25%|##4       | 421/1698 [00:00<00:01, 1048.65it/s]     30%|##9       | 501/1698 [00:00<00:01, 940.06it/s]      34%|###4      | 579/1698 [00:00<00:01, 852.15it/s]     39%|###8      | 655/1698 [00:00<00:01, 797.43it/s]     43%|####2     | 729/1698 [00:00<00:01, 752.70it/s]     47%|####7     | 801/1698 [00:00<00:01, 719.60it/s]     51%|#####1    | 871/1698 [00:01<00:01, 621.85it/s]     55%|#####5    | 934/1698 [00:01<00:01, 529.97it/s]     58%|#####8    | 990/1698 [00:01<00:01, 523.72it/s]     62%|######1   | 1052/1698 [00:01<00:01, 547.46it/s]     66%|######5   | 1114/1698 [00:01<00:01, 565.41it/s]     70%|######9   | 1187/1698 [00:01<00:00, 606.26it/s]     85%|########5 | 1446/1698 [00:01<00:00, 787.10it/s]    100%|##########| 1698/1698 [00:01<00:00, 941.81it/s]



Cleaning
--------
Each fiber group is cleaned to exclude streamlines that are outliers in terms
of their trajector and/or length.


.. code-block:: default


    print("Cleaning fiber groups...")
    for bundle in bundles:
        print(f"Cleaning {bundle}")
        print(f"Before cleaning: {len(fiber_groups[bundle]['sl'])} streamlines")
        new_fibers, idx_in_bundle = seg.clean_bundle(
            fiber_groups[bundle]['sl'],
            return_idx=True)
        print(f"Afer cleaning: {len(new_fibers)} streamlines")

        idx_in_global = fiber_groups[bundle]['idx'][idx_in_bundle]
        np.save(f'{bundle}_idx.npy', idx_in_global)
        sft = StatefulTractogram(new_fibers.streamlines,
                                 img,
                                 Space.VOX)
        sft.to_rasmm()
        save_tractogram(sft, f'./{bundle}_afq.trk',
                        bbox_valid_check=False)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Cleaning fiber groups...
    Cleaning CST_R
    Before cleaning: 37 streamlines
    Afer cleaning: 36 streamlines
    Cleaning CST_L
    Before cleaning: 53 streamlines
    Afer cleaning: 48 streamlines
    Cleaning ARC_R
    Before cleaning: 8 streamlines
    Afer cleaning: 8 streamlines
    Cleaning ARC_L
    Before cleaning: 25 streamlines
    Afer cleaning: 25 streamlines



Bundle profiles
---------------
Streamlines are represented in the original diffusion space (`Space.VOX`) and
scalar properties along the length of each bundle are queried from this scalar
data. Here, the contribution of each streamline is weighted according to how
representative this streamline is of the bundle overall.


.. code-block:: default


    print("Extracting tract profiles...")
    for bundle in bundles:
        sft = load_tractogram(f'./{bundle}_afq.trk', img, to_space=Space.VOX)
        fig, ax = plt.subplots(1)
        weights = gaussian_weights(sft.streamlines)
        profile = afq_profile(FA_data, sft.streamlines,
                              np.eye(4), weights=weights)
        ax.plot(profile)
        ax.set_title(bundle)

    plt.show()




.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/images/sphx_glr_plot_tract_profile_001.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_tract_profile_002.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_tract_profile_003.png
            :class: sphx-glr-multi-img

    *

      .. image:: /auto_examples/images/sphx_glr_plot_tract_profile_004.png
            :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Extracting tract profiles...
    /Users/arokem/source/pyAFQ/examples/plot_tract_profile.py:198: UserWarning: Matplotlib is currently using agg, which is a non-GUI backend, so cannot show the figure.
      plt.show()



References:
-------------------------
.. [Yeatman2012] Jason D Yeatman, Robert F Dougherty, Nathaniel J Myall, Brian
                 A Wandell, Heidi M Feldman, "Tract profiles of white matter
                 properties: automating fiber-tract quantification", PloS One,
                 7: e49790

.. [Yeatman2014] Jason D Yeatman, Brian A Wandell, Aviv Mezer Feldman,
                 "Lifespan maturation and degeneration of human brain white
                 matter", Nature Communications 5: 4932


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 2 minutes  24.762 seconds)


.. _sphx_glr_download_auto_examples_plot_tract_profile.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_tract_profile.py <plot_tract_profile.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_tract_profile.ipynb <plot_tract_profile.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
